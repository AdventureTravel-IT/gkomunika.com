{{ 'product-category-pages.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-category-pages.js' | asset_url }}" defer></script>

<div class="main-search">
  <div
    class="main-search-container"
    data-no-match-text="{{ 'search.no_match_filter' | t | escape }}"
    data-default-filter="{{ section.settings.default_filter | default: 'esim' | escape }}"
  >
    {%- assign collections_to_check = 'single-country,multi-country,insurance' | split: ',' -%}
    {%- assign found_any_product = false -%}

    <div class="sim-filter-buttons">
      <button class="filter-btn" data-filter="all" type="button">
        {{ 'search.filter.all' | t }}
      </button>

      <button class="filter-btn" data-filter="esim" type="button">
        {{ 'product.sim_type.esim' | t }}
      </button>

      <button class="filter-btn" data-filter="sim-card" type="button">
        {{ 'product.sim_type.sim_card' | t }}
      </button>

      <button class="filter-btn" data-filter="insurance" type="button">
        {{ 'product.card.insurance_label' | t }}
      </button>
    </div>

    {% for collection_key in collections_to_check %}
      {% assign collection = collections[collection_key] %}
      {% if collection %}
        <div class="main-search-collection-wrapper" id="collection-{{ collection_key }}">
          <h1 class="main-search-collection title">{{ collection.title }}</h1>

          <div class="main-search-collection">
            <div class="product-card-wrapper" id="{{ collection_key }}">
              {% for product in collection.products %}
                {%- assign found_any_product = true -%}

                {%- assign product_category_raw = product.metafields.product.category.value | default: '' -%}
                {%- assign cat_norm = product_category_raw
                  | strip
                  | downcase
                  | replace: '_', '-'
                  | replace: ' ', '-'
                  | replace: '--', '-'
                  | replace: '--', '-'
                -%}

                {% assign is_insurance_fallback = false %}
                {% if product.product_type != blank %}
                  {% assign pt = product.product_type | downcase %}
                  {% if pt contains 'insurance' %}
                    {% assign is_insurance_fallback = true %}
                  {% endif %}
                {% endif %}
                {% if is_insurance_fallback %}
                  {% if cat_norm == '' or cat_norm == 'undefined' %}
                    {% assign cat_norm = 'insurance' %}
                  {% endif %}
                {% endif %}

                {% if cat_norm == 'sim_card'
                  or cat_norm == 'sim-card'
                  or cat_norm == 'simcard'
                  or cat_norm == 'sim-card-'
                %}
                  {% assign cat_norm = 'sim-card' %}
                {% endif %}

                {%- assign is_insurance = false -%}
                {% if cat_norm == 'insurance' %}
                  {% assign is_insurance = true %}
                {% endif %}

                {% if cat_norm == 'gsim' %}
                  {% assign sim_type_classes = 'sim-type-esim sim-type-sim-card' %}
                {% elsif cat_norm == 'sim_card' %}
                  {% assign sim_type_classes = 'sim-type-sim-card' %}
                {% elsif cat_norm != blank %}
                  {% assign sim_type_classes = 'sim-type-' | append: cat_norm %}
                {% else %}
                  {% assign sim_type_classes = 'sim-type-unknown' %}
                {% endif %}

                {%- assign search_keys = product.metafields.search.key.value -%}
                {%- assign country_name = '' -%}
                {%- assign alias_string = '' -%}

                {% if search_keys != blank %}
                  {% for search_key in search_keys %}
                    {% assign country_name = country_name | append: search_key.country.value | append: ',' %}
                    {% if search_key.alias.value %}
                      {% assign alias_clean = search_key.alias.value | join: ',' %}
                      {% assign alias_string = alias_string | append: alias_clean | append: ',' %}
                    {% endif %}
                  {% endfor %}
                {% endif %}

                {%- assign product_countries = product.metafields.coverage.country.value -%}
                {% if product_countries == blank %}
                  {% assign product_countries = '' | split: ',' %}
                {% endif %}

                <div
                  class="product-card-container {{ sim_type_classes }}"
                  data-country="{{ country_name | strip | downcase }}"
                  data-alias="{{ alias_string | strip | downcase }}"
                >
                  <a class="product-url-link" href="{{ product.url }}">
                    <div class="product-card-country">
                      {% assign total_countries = product_countries.size %}

                      {% if total_countries == 1 %}
                        {% assign country_trimmed = product_countries.first | strip %}
                        {% assign country_filename = country_trimmed | replace: ' ', '-' | append: '.svg' %}
                        <img
                          class="product-card-icon-single-flag"
                          src="{{ country_filename | file_url }}"
                          alt="{{ country_trimmed }}"
                          width="50"
                          height="50"
                          loading="lazy"
                          decoding="async"
                        >
                      {% else %}
                        <div class="product-card-multi-flag">
                          {% for country in product_countries limit: 3 %}
                            {% assign country_parts = country | split: '_' %}
                            {% assign country_processed = country_parts | join: '_' | replace: ' ', '-' %}
                            {% assign country_filename = country_processed | append: '.svg' %}
                            <img
                              class="product-card-icon-multi-flag"
                              src="{{ country_filename | file_url }}"
                              alt="{{ country_processed }}"
                              width="25"
                              height="25"
                              loading="lazy"
                              decoding="async"
                            >
                          {% endfor %}

                          {% if total_countries > 3 %}
                            <div class="product-card-flag-count">
                              <span>+{{ total_countries | minus: 3 }}</span>
                            </div>
                          {% endif %}
                        </div>
                      {% endif %}

                      <div class="main-search__product">
                        {% if is_insurance %}
                          <span class="main-search__product-type">
                            {{ 'product.card.insurance_label' | t }}
                          </span>
                        {% else %}
                          {% assign product_category_label = product_category_raw | replace: '_', ' ' %}
                          {% if product_category_raw == 'gSIM' %}
                            {% assign product_category_label = 'SIM Card & eSIM ' %}
                          {% endif %}
                          <span
                            class="main-search__product-type"
                            {% if product_category_raw == 'SIM_Card' %}
                              style="background-color: var(--color-secondary);"
                            {% endif %}
                          >
                            {{ 'product.card.sim_type_prefix' | t }}
                            {{ product_category_label }}
                          </span>
                        {% endif %}

                        <h1>{{ product.title }}</h1>
                      </div>
                    </div>
                  </a>

                  <div class="product-card-content">
                    <div class="product-card-content-flip-front">
                      {% if product_countries.size > 1 %}
                        <div class="product-card-field" style="border-top: 1px ridge;">
                          <div class="product-card-field-icons">
                            <img
                              class="field-icon"
                              src="{{ 'icon-park-outline_world.svg' | asset_url }}"
                              alt="Icon"
                              width="30"
                              height="30"
                              loading="lazy"
                              decoding="async"
                            >
                            <h1>{{ 'product.card.coverage' | t }}</h1>
                          </div>

                          <div class="country-total-atribut-wrapper">
                            <div class="country-total-atribut">
                              <button class="flipped-trigger" type="button">
                                <span>{{ 'product.card.countries' | t: count: product_countries.size }}</span>
                              </button>
                            </div>

                            {% if alias_string != blank %}
                              {% assign alias_array = alias_string | split: ',' | uniq %}
                              {% if alias_array.size > 0 %}
                                <div class="country-total-including-atribut hidden">
                                  <p>
                                    {{ 'product.card.including' | t }}
                                    {{ alias_array | join: ', ' }}
                                  </p>
                                </div>
                              {% endif %}
                            {% endif %}
                          </div>
                        </div>
                      {% endif %}

                      {% if product.variants.size > 0 %}
                        {% assign first_optiondays = product.variants.first.option1 | replace: ' Days', '' %}
                        {% assign last_optiondays = product.variants.last.option1 | strip %}
                        {% assign last_optionquota = product.variants.last.option2 | strip %}

                        {% unless is_insurance %}
                          <div class="product-card-field">
                            <div class="product-card-field-icons">
                              <img
                                class="field-icon"
                                src="{{ 'icon-tabler_mobiledata.svg' | asset_url }}"
                                alt="Icon"
                                width="30"
                                height="30"
                                loading="lazy"
                                decoding="async"
                              >
                              <h1>{{ 'product.card.data' | t }}</h1>
                            </div>
                            <h2>{{ last_optionquota }}</h2>
                          </div>
                        {% endunless %}

                        <div class="product-card-field">
                          <div class="product-card-field-icons">
                            <img
                              class="field-icon"
                              src="{{ 'icon-date-range.svg' | asset_url }}"
                              alt="Icon"
                              width="30"
                              height="30"
                              loading="lazy"
                              decoding="async"
                            >
                            <h1>{{ 'product.card.days' | t }}</h1>
                          </div>

                          {% if is_insurance %}
                            <h2>{{ 'product.card.days_insurance' | t }}</h2>
                          {% else %}
                            <h2>{{ first_optiondays }} - {{ last_optiondays }}</h2>
                          {% endif %}
                        </div>

                        <div class="product-card-field">
                          <div class="product-card-field-icons">
                            <img
                              class="field-icon"
                              src="{{ 'icon-dollar.svg' | asset_url }}"
                              alt="Icon"
                              width="30"
                              height="30"
                              loading="lazy"
                              decoding="async"
                            >
                            <h1>{{ 'product.card.price' | t }}</h1>
                          </div>
                          <h2>
                            {{ 'product.card.price_from_prefix' | t }}
                            {{ product.price | money_with_currency }}
                          </h2>
                        </div>
                      {% endif %}
                    </div>

                    <div class="product-card-content-flip-back" data-coverage-mounted="false">
                      <div class="coverage-mount"></div>
                      <template class="coverage-template">
                        {% render 'coverage', product: product %}
                      </template>
                    </div>
                  </div>

                  <div class="product-card-button">
                    <a class="product-url-link" href="{{ product.url }}">
                      <button class="product-card-btn" type="button">
                        <p>{{ 'product.card.button_gsim' | t }}</p>
                      </button>
                    </a>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}

    {% unless found_any_product %}
      <div class="main-search__error">
        <p>{{ 'search.no_products' | t }}</p>
      </div>
    {% endunless %}
  </div>
</div>

{% schema %}
{
  "name": "Product Category Pages",
  "settings": [
    {
      "type": "select",
      "id": "default_filter",
      "label": "Default filter",
      "options": [
        { "value": "esim", "label": "eSIM" },
        { "value": "sim-card", "label": "SIM Card" },
        { "value": "insurance", "label": "Insurance" },
        { "value": "all", "label": "All" }
      ],
      "default": "esim"
    }
  ],
  "presets": [
    {
      "name": "Product Category Pages",
      "category": "Custom"
    }
  ]
}
{% endschema %}
