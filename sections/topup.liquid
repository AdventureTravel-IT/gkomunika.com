{% comment %} <span id="iccid-display"></span> {% endcomment %}

{% comment %} wrapper untuk hasil filter pada saat input search {% endcomment %}
<div class="product-card-wrapper"></div>

<div id="no-results-message" class="main-search__error" style="display:none;">
  <p>No products match your search.</p>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const iccid = sessionStorage.getItem('iccid');

    if (iccid) {
      // misalnya otomatis isi ke input:
      const iccidInput = document.getElementById('your-iccid-input');
      if (iccidInput) {
        iccidInput.value = iccid;
      }

      // atau tampilkan ke span
      const iccidSpan = document.getElementById('iccid-display');
      if (iccidSpan) {
        iccidSpan.textContent = iccid;
      }
    }
  });
</script>

{% comment %} # STYLES SECTION {% endcomment %}
{% style %}
  /* (Styles tetap sesuai file awalmu) */
  .main-search {
    max-width: 1920px;
    margin: 0 auto;
  }
  .main-search-container {
    background-color: var(--color-background);
    padding: 20px 10% 90px;
  }
  /* HAPUS .sim-filter-buttons styles karena tidak dipakai lagi */

  /* Keep your original styles unchanged below */
  .main-search-collection-wrapper {
    margin-bottom: 30px;
  }
  .main-search-collection {
    margin-top: 20px;
  }
  .main-search-collection.title {
    margin: 0 0 10px;
    font-weight: bold;
    color: var(--color-primary);
    font-size: 26px;
  }
  .product-card-wrapper {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    width: 100%;
    height: 100%;
  }
  .product-card-container {
    display: flex;
    gap: 10px;
    flex-direction: column;
    padding: 15px;
    background-color: white;
    border-radius: 25px;
    box-shadow: var(--box-shadow);
  }
  .product-card-country {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    margin-bottom: 20px;
    min-height: 53px;
  }
  .product-card-country h1 {
    margin: 0;
    color: var(--color-primary);
    font-size: 20px;
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .product-card-icon-single-flag {
    border-radius: 15px;
    border: 1px solid var(--color-border);
  }
  .product-card-multi-flag,
  .product-card-icon-multi-flag {
    flex-shrink: 0;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 3px;
    border-radius: 5px;
  }
  .product-card-icon-multi-flag {
    border: 1px solid var(--color-border);
  }
  .product-card-flag-count {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 25px;
    height: 25px;
    border: 1px solid var(--color-border);
    border-radius: 5px;
    color: var(--color-primary);
    background-color: white;
  }
  .product-card-flag-count span {
    font-size: 10px;
    font-weight: bold;
    color: var(--color-primary);
  }
  .product-url-link {
    text-decoration: none;
    color: var(--color-primary);
  }
  .product-card-field-icons {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
  }
  .product-card-field-icons h1 {
    font-size: 18px;
    font-weight: bold;
    color: var(--color-primary);
  }
  .product-card-field-icons h2 {
    word-break: break-word;
    -webkit-line-clamp: 2;
  }
  .product-card-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px ridge;
    padding: 5px 0;
  }
  img.field-icon {
    width: 30px;
    height: 30px;
  }
  .product-card-field h2 {
    font-size: 16px;
    font-weight: bold;
    color: var(--color-secondary);
  }
  .product-card-btn {
    width: 100%;
    height: 55px;
    background-color: var(--color-primary);
    border: none;
    border-radius: 15px;
    cursor: pointer;
  }
  .product-card-btn p {
    font-size: var(--font-large);
    font-weight: bold;
    color: var(--color-neutral);
    margin: 0;
  }
  .product-card-content {
    position: relative;
    width: 100%;
    height: 100%;
    margin-bottom: 10px;
    transform-style: preserve-3d;
    transition: transform 0.6s ease-in-out;
  }
  .product-card-container .product-card-content {
    transform: rotateY(0deg);
  }
  .product-card-container.flipped .product-card-content {
    transform: rotateY(180deg);
  }
  .product-card-content-flip-front,
  .product-card-content-flip-back {
    backface-visibility: hidden;
    transition: transform 0.6s ease-in-out;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 7px;
  }
  .product-card-content-flip-back {
    position: absolute;
    top: 0;
    left: 0;
    overflow-y: hidden;
    background: var(--color-neutral);
    text-align: center;
    cursor: pointer;
    transform: rotateY(180deg);
  }

  .product-card-container.flipped .product-card-content-flip-back {
    overflow-y: auto; /* aktifkan scroll hanya ketika flipped */
  }
  .country-total-atribut-wrapper {
    max-width: 125px;
    padding: 2px 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .country-total-atribut span {
    font-size: 12px;
    font-weight: bold;
    color: var(--color-secondary);
  }
  .country-total-atribut button {
    width: 100%;
    padding: 10px;
    cursor: pointer;
    border-radius: 10px;
    border: 1px solid var(--color-primary);
    background: none;
  }
  .country-total-including-atribut {
    background-color: var(--color-primary);
    text-align: center;
    border-radius: 5px;
  }
  .country-total-including-atribut p {
    margin: 5px;
    font-size: 12px;
    font-weight: bold;
    color: var(--color-neutral);
  }
  .main-search__product-type {
    background-color: var(--color-primary);
    border-radius: 5px;
    padding: 5px;
    color: var(--color-neutral);
    font-size: 12px;
    margin: 0;
    font-weight: bold;
  }
  .main-search__error {
    display: flex;
    justify-content: center;
    border-radius: 15px;
    padding: 15px;
  }
  .main-search__error p {
    font-size: var(--font-supper-large);
    color: var(--color-primary);
  }
  @media (max-width: 1600px) {
    .product-card-wrapper {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  @media (max-width: 1024px) {
    .product-card-wrapper {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 768px) {
    .main-search-container {
      padding: 20px 10%;
    }
    .banner-search__content {
      width: 100%;
    }
  }
  @media (max-width: 426px) {
    .product-card-wrapper {
      grid-template-columns: repeat(1, 1fr);
    }
    .main-search-container {
      padding: 20px 24px;
    }
  }
{% endstyle %}

{% comment %} # JAVASCRIPT SECTION {% endcomment %}
<script>
  (function () {
    'use strict';

    // Jalankan setelah semua elemen betul-betul ada
    window.addEventListener('load', function () {
      // ------- Elemen utama -------
      const collectionWrapper = document.getElementById('collection-top-up-plan');
      const noResults = document.getElementById('no-results-message');

      // Helper
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      // ------- Flip card (tetap) -------
      $$('.flipped-trigger').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const card = btn.closest('.product-card-container');
          if (card) card.classList.toggle('flipped');
        });
      });

      document.addEventListener('click', (e) => {
        $$('.product-card-container.flipped').forEach((card) => {
          if (!card.contains(e.target) || e.target.closest('.product-card-content-flip-back')) {
            card.classList.remove('flipped');
          }
        });
      });

      // ------- Mapping prefix -> vendor -------
      const vendorPrefixes = [
        { prefix: '8985234202227', vendor: 'BE' },
        { prefix: '8985234202222', vendor: 'SEM' },
        { prefix: '8981200', vendor: 'BE' },
        { prefix: '89859', vendor: 'AF' },
        { prefix: '89862', vendor: 'AF' },
        { prefix: '89810', vendor: 'TE' },
        { prefix: '2210', vendor: 'BS' },
      ];

      const vendorCategories = {
        SEM: 'Top_Up_D',
        AF: 'Top_Up_B',
        TE: 'Top_Up_C',
        BS: 'Top_Up_A',
        BE: 'Top_Up_A',
      };

      function findVendorFromICCID(raw) {
        const iccid = String(raw || '').trim();
        let matchedVendor = null;
        let longest = 0;
        vendorPrefixes.forEach((it) => {
          if (iccid.startsWith(it.prefix) && it.prefix.length > longest) {
            longest = it.prefix.length;
            matchedVendor = it.vendor;
          }
        });
        return matchedVendor;
      }

      function showNotFoundMessage() {
        if (collectionWrapper) collectionWrapper.style.display = 'none';
        if (noResults) {
          noResults.innerHTML = `
            <div style="display:flex; flex-direction:column; justify-content:center">
              <p>No products found in Top-Up Plan.</p>
              <a href="/pages/check-data-usage">
                <button class="product-card-btn">
                  <p style="color: var(--color-neutral);">Back</p>
                </button>
              </a>
            </div>
          `;
          noResults.style.display = 'flex';
        }
      }

      function showCollection() {
        if (noResults) noResults.style.display = 'none';
        if (collectionWrapper) collectionWrapper.style.display = '';
      }

      // ------- Ambil ICCID -------
      const iccid = (sessionStorage.getItem('iccid') || '').trim();
      if (!iccid) {
        return showNotFoundMessage();
      }

      // ------- Resolve vendor -> kategori -------
      const vendor = findVendorFromICCID(iccid);
      if (!vendor) {
        return showNotFoundMessage();
      }

      const desiredCategory = vendorCategories[vendor];
      if (!desiredCategory) {
        return showNotFoundMessage();
      }
      const desired = desiredCategory.trim().toUpperCase();

      // ------- Ambil semua card di dalam wrapper -------
      if (!collectionWrapper) {
        return showNotFoundMessage();
      }

      const productCards = $$('.product-card-container', collectionWrapper);

      // **PRE-HIDE** semua card dulu agar tidak "muncul semua" saat awal
      productCards.forEach((c) => (c.style.display = 'none'));

      // ------- Filter by data-category (case-insensitive) -------
      const visibleCards = [];
      productCards.forEach((card, idx) => {
        // NOTE: pastikan Liquid mengisi data-category="{{ product.metafields.product.category.value }}"
        let cat = card.dataset.category;

        // Beberapa theme/metafield bisa return array -> stringify, jadi normalisasi
        if (Array.isArray(cat)) cat = cat[0];
        if (cat && typeof cat !== 'string') cat = String(cat);

        const norm = (cat || '').trim().toUpperCase();
        if (!norm) {
          card.style.display = 'none';
          return;
        }

        if (norm === desired) {
          card.style.display = ''; // tampilkan
          visibleCards.push(card);
        }
      });

      if (visibleCards.length === 0) {
        return showNotFoundMessage();
      }

      // Tampilkan wrapper setelah selesai filter (anti-flash)
      showCollection();

      // Jika hanya satu, auto-redirect
      if (visibleCards.length === 1) {
        const linkEl = visibleCards[0].querySelector('a.product-url-link');
        if (linkEl && linkEl.href) {
          window.location.assign(linkEl.href);
        }
      }
    });
  })();
</script>

{% comment %} # TEMPLATE SECTION {% endcomment %}
<div class="main-search">
  <div class="main-search-container">
    {% assign collection = collections['top-up-plan'] %}
    {% assign found_any_product = false %}
    {% assign single_product_url = '' %}
    {% assign product_count = 0 %}

    {% if collection and collection.products.size > 0 %}
      <div class="main-search-collection-wrapper" id="collection-top-up-plan">
        <h1 class="main-search-collection title">{{ collection.title }}</h1>
        <div class="main-search-collection">
          <div class="product-card-wrapper">
            {% for product in collection.products %}
              {% assign found_any_product = true %}
              {% assign product_count = product_count | plus: 1 %}
              {% assign single_product_url = product.url %}

              {% assign product_countries = product.metafields.coverage.country.value %}
              {% assign all_matched_countries = '' %}
              {% if product_countries %}
                {% for country in product_countries %}
                  {% assign all_matched_countries = all_matched_countries | append: country | append: ', ' %}
                {% endfor %}
              {% endif %}

              <div
                class="product-card-container"
                data-category="{{ product.metafields.product.category.value }}"
                data-coverage-country="{{ product.metafields.coverage.country.value | join: ', ' }}"
                data-coverage-alias="{{ product.metafields.coverage.alias.value | join: ', ' }}"
                data-coverage-region="{{ product.metafields.coverage.region.value | join: ', ' }}"
              >
                <a class="product-url-link" href="{{ product.url }}">
                  <div class="product-card-country">
                    {% assign total_countries = product_countries.size %}
                    {% if total_countries == 1 %}
                      {% assign country_trimmed = product_countries.first | strip %}
                      {% assign country_filename = country_trimmed | replace: ' ', '-' | append: '.svg' %}
                      <img
                        class="product-card-icon-single-flag"
                        src="{{ country_filename | file_url }}"
                        alt="{{ country_trimmed }}"
                        width="50"
                        height="50"
                      >
                    {% elsif total_countries > 1 %}
                      <div class="product-card-multi-flag">
                        {% for country in product_countries limit: 3 %}
                          {% assign country_filename = country | replace: ' ', '-' | append: '.svg' %}
                          <img
                            class="product-card-icon-multi-flag"
                            src="{{ country_filename | file_url }}"
                            alt="{{ country }}"
                            width="25"
                            height="25"
                          >
                        {% endfor %}
                        {% if total_countries > 3 %}
                          <div class="product-card-flag-count">
                            <span>+{{ total_countries | minus: 3 }}</span>
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                    <div class="main-search__product">
                      <span class="main-search__product-type">
                        {% assign cat = product.metafields.product.category.value | strip %}
                        {% if cat == 'Top_Up_D' %}
                          eSIM
                        {% else %}
                          Top Up Plan
                        {% endif %}
                      </span>

                      <h1>{{ product.title }}</h1>
                    </div>
                  </div>
                </a>

                <div class="product-card-content">
                  <div class="product-card-content-flip-front">
                    {% if product_countries.size > 1 %}
                      <div class="product-card-field" style="border-top: 1px ridge;">
                        <div class="product-card-field-icons">
                          <img class="field-icon" src="{{ 'icon-park-outline_world.svg' | asset_url }}" alt="Icon">
                          <h1>Coverage</h1>
                        </div>
                        <div class="country-total-atribut-wrapper">
                          <div class="country-total-atribut">
                            <button class="flipped-trigger">
                              <span>{{ product_countries.size }} Countries</span>
                            </button>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if product.variants.size > 0 %}
                      {% assign first_optiondays = product.variants.first.option1 | replace: ' Days', '' %}
                      {% assign last_optiondays = product.variants.last.option1 | strip %}
                      {% assign last_optionquota = product.variants.last.option2 | strip %}

                      <div class="product-card-field">
                        <div class="product-card-field-icons">
                          <img
                            class="field-icon"
                            src="{{ 'icon-tabler_mobiledata.svg' | asset_url }}"
                            width="24"
                            height="24"
                            alt="Icon"
                          >
                          <h1>Data</h1>
                        </div>
                        <h2>{{ last_optionquota }}</h2>
                      </div>

                      <div class="product-card-field">
                        <div class="product-card-field-icons">
                          <img
                            class="field-icon"
                            src="{{ 'icon-date-range.svg' | asset_url }}"
                            width="24"
                            height="24"
                            alt="Icon"
                          >
                          <h1>Days</h1>
                        </div>
                        <h2>{{ first_optiondays }} - {{ last_optiondays }}</h2>
                      </div>

                      <div class="product-card-field">
                        <div class="product-card-field-icons">
                          <img class="field-icon" src="{{ 'icon-dollar.svg' | asset_url }}" alt="Icon">
                          <h1>Price</h1>
                        </div>
                        <h2>From {{ product.price | money_with_currency }}</h2>
                      </div>
                    {% endif %}
                  </div>
                  <div class="product-card-content-flip-back">
                    {% render 'coverage', product: product %}
                  </div>
                </div>

                <div class="product-card-button">
                  <a class="product-url-link" href="{{ product.url }}">
                    <button class="product-card-btn">
                      <p>Buy Now</p>
                    </button>
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% else %}
      <div class="main-search__error">
        <p>No products found in Top-Up Plan.</p>
      </div>
    {% endif %}

    {% if product_count == 1 %}
      <script>
        window.location.href = '{{ single_product_url }}';
      </script>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Section Top Up",
  "settings": [],
  "presets": [
    {
      "name": "Section Top Up",
      "category": "Custom"
    }
  ]
}
{% endschema %}
