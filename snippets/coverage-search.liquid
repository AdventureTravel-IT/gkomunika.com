<div class="search-container">
  <form action="{{ routes.search_url }}" method="get" class="search-form" onsubmit="return false;">
    <div class="search-box">
      <input
        class="search-fields"
        id="search-input"
        type="search"
        name="q"
        value="{{ search.terms | escape }}"
        oninput="filterCountries()"
        placeholder="{{ 'general.search.search' | t }}"
        aria-label="Search"
      >
    </div>
  </form>
  <div id="search-empty" class="search-empty" style="display:none;" role="status" aria-live="polite">
  country not found
</div>

</div>

<script>
const searchInput = document.getElementById('search-input');
const emptyMsg = document.getElementById('search-empty');

// subsequence match supaya "chn" tetap cocok "china"
function isSubsequence(q, t) {
  q = (q || '').toLowerCase();
  t = (t || '').toLowerCase();
  let i = 0;
  for (const ch of t) if (ch === q[i]) i++;
  return q.length > 0 && i === q.length;
}

function matches(haystack, needle) {
  if (!needle) return true; // input kosong = tampilkan semua
  haystack = (haystack || '').toLowerCase();
  needle = (needle || '').toLowerCase();
  return haystack.includes(needle) || isSubsequence(needle, haystack);
}

function filterCountries() {
  const input = (searchInput.value || '').trim().toLowerCase();
  const items = document.querySelectorAll('#coverage-container .coverage-item');
  let found = 0;

  items.forEach(item => {
    const byAttr = (item.getAttribute('data-country') || '').toLowerCase();
    const byRaw  = (item.getAttribute('data-country-raw') || '').toLowerCase();
    const byText = (item.textContent || '').toLowerCase();
    const hay = `${byAttr} ${byRaw} ${byText}`.replace(/_/g, ' ');

    const show = matches(hay, input);
    item.style.display = show ? '' : 'none';
    if (show) found++;
  });

  // tampilkan pesan jika ada input & tidak ada hasil
  if (input && found === 0) {
    emptyMsg.style.display = 'block';
  } else {
    emptyMsg.style.display = 'none';
  }
}

// ekspos ke global supaya dipanggil ulang saat coverage re-render
window.filterCountries = filterCountries;
</script>

<style>
  input[type="search"]::-webkit-search-cancel-button { display: none; }
  .search-container, .search-form { display:flex; flex-direction:column; align-items:center; width:100%; }
  .search-box { position:relative; width:100%; height:60px; }
  .search-fields { width:100%; height:100%; padding:0 10px; font-size:16px; border:1px solid var(--color-primary); border-radius:15px; outline:none; color:var(--color-primary); }
  .search-fields:focus { border-color:var(--color-primary); color:var(--color-primary); font-size:var(--font-large); }
  .search-fields::placeholder { color:var(--color-primary); }

  .search-empty {
    width:100%;
    margin-top:8px;
    padding:10px;
    border:1px dashed var(--color-primary);
    border-radius:8px;
    color:var(--color-primary);
    background:transparent;
  }
</style>
